---
title: "AGP"
output: html_document
date: "2023-12-28"
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo= TRUE, warning = FALSE, message = FALSE) 
```


***********
# 1. IMPORT
***********

## 1.1. Libraries

```{r library-import}
library(MicrobiotaProcess) # an R package for analysis, visualization and biomarker discovery of Microbiome
library(phyloseq) # Handling and analysis of high-throughput microbiome census data.
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics.
library(tidyverse) # Easily Install and Load the 'Tidyverse'.
library(vegan) # Community Ecology Package.
library(coin) # Conditional Inference Procedures in a Permutation Test Framework.
library(reshape2) # Flexibly Reshape Data: A Reboot of the Reshape Package.
library(ggnewscale) # Multiple Fill and Colour Scales in 'ggplot2'
library(patchwork)
library(VennDiagram)
library(UpSetR)
library(ggtree)
library(ggsignif)
library(cowplot)
library(microViz)
```


```{r path-directories, echo=FALSE}
# ROOT DIRECTORY (to modify on your computer)
path.root <- "C:/Users/Gilar/OneDrive/Escritorio/Master/5_Semester/Thesis/MetaIBS"
path.fukui  <- file.path(path.root, "Analysis/Scripts/Individual/AGP")
path.data <- file.path(path.root, "data/phyloseq-objects")
path.plots <- file.path(path.root, "Analysis/Plots/Individual/AGP")
```


## Read data
```{r read-data, echo=FALSE}
physeq <- readRDS(file.path(path.data, "physeq_agp.rds")) # phyloseq object
```

**************************
# 2. DESCRIPTIVE ANAYLISIS
**************************

## 2.1. Demographic and Clinical Information

```{r demographic-information, echo=FALSE}

# Number of disease VS healthy (%)
physeq@sam_data%>%
  group_by(host_disease)%>%
  count()


# Age mean and sd per disease status
physeq@sam_data%>%
  group_by(host_age)%>%
  summarize(mean = mean(host_age), 
            sd = sd(host_age))

# Histogramm of age per disease status
ggplot(physeq@sam_data, aes(host_age))+
  geom_histogram(aes(fill=host_disease))+
  facet_grid(host_disease~.)

# Bar chart of age categories per disease status
physeq@sam_data$age_cat <- factor(physeq@sam_data$age_cat,
                                  levels=c("teen", "20s", "30s", "40s",
                                           "50s", "60s"))
ggplot(physeq@sam_data, aes(x = age_cat)) + 
  geom_bar(aes(x = age_cat, fill = factor(age_cat))) +
  facet_grid(host_disease~.)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Age Category")+
  ylab("count")


# BMI mean and sd per disease status
physeq@sam_data%>%
  group_by(host_disease)%>%
  summarize(mean = mean(host_bmi), 
            sd = sd(host_bmi))

# Histogramm of bmi per disease status
ggplot(physeq@sam_data, aes(host_bmi))+
  geom_density(aes(fill=host_disease))+
  expand_limits(x=0)+
  facet_grid(host_disease~.)


# Bar chart of bmi categories per disease status
physeq@sam_data$bmi_cat <- factor(physeq@sam_data$bmi_cat,
                                  levels=c("Underweight", "Normal", "Obese",
                                           "Overweight"))
ggplot(physeq@sam_data, aes(x = bmi_cat)) + 
  geom_bar(aes(x = bmi_cat, fill = bmi_cat)) +
  facet_grid(host_disease~.)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("BMI Category")+
  ylab("count")



# Race
ggplot(physeq@sam_data, aes(x = RACE)) + 
  geom_bar(aes(x = RACE, fill = RACE)) +
  facet_grid(host_disease~.)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Race")+
  ylab("count")



# Exercise Frequency
physeq@sam_data$exercise_frequency <- factor(physeq@sam_data$exercise_frequency,
                                  levels=c("Never", 
                                           "Rarely (a few times/month)",
                                           "Occasionally (1-2 times/week)",
                                           "Regularly (3-5 times/week)",
                                           "Daily"))
                      
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~exercise_frequency)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Exercise Frequency Category")+
  ylab("count")


# Alcohol Frequency
physeq@sam_data$alcohol_frequency <- factor(physeq@sam_data$alcohol_frequency,
                                  levels=c("Never", 
                                           "Rarely (a few times/month)",
                                           "Occasionally (1-2 times/week)",
                                           "Regularly (3-5 times/week)",
                                           "Daily"))

ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~alcohol_frequency)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Alcohol Frequency Category")+
  ylab("count")


# Probiotic Frequency
physeq@sam_data$probiotic_frequency <- factor(physeq@sam_data$probiotic_frequency,
                                  levels=c("Never", 
                                           "Rarely (a few times/month)",
                                           "Occasionally (1-2 times/week)",
                                           "Regularly (3-5 times/week)",
                                           "Daily"))

ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~probiotic_frequency)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Probiotic Frequency Category")+
  ylab("count")


# Gluten
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~gluten)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Gluten Allergy")+
  ylab("count")


# Bowel Movement Frequency
physeq@sam_data$bowel_movement_frequency <- factor(physeq@sam_data$bowel_movement_frequency,
                                  levels=c("Less than one", "One", "Two", "Three", "Four",
                                           "Five or more"))

ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease,
               fill = host_disease)) +
  facet_grid(.~bowel_movement_frequency)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Bowel Movement Frequency")+
  ylab("count")


# Season
physeq@sam_data$collection_season <- factor(physeq@sam_data$collection_season,
                                  levels=c("Winter", "Spring", 
                                           "Summer", "Fall"))

ggplot(physeq@sam_data, aes(x = collection_season)) + 
  geom_bar(aes(x = collection_season,
               fill = collection_season)) +
  facet_grid(host_disease~.)+
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3)+
  xlab("Season Collection")+
  ylab("count")


# Lactose
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~lactose) +
  geom_text(aes(label=after_stat(count)),stat='count',
            position=position_dodge(0.9),vjust=-0.3) +
  xlab("Lactose")+
  ylab("count")


# Lung Disease
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~lung_disease)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Lung Disease")+
  ylab("count")


# Liver disease
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~liver_disease)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Liver Disease")+
  ylab("count")


# Kidney Disease
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~kidney_disease)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Kidney Disease")+
  ylab("count")


# Clinical Condition
ggplot(physeq@sam_data, aes(x = host_disease)) + 
  geom_bar(aes(x = host_disease, fill = host_disease)) +
  facet_grid(.~clinical_condition)+
  geom_text(aes(label=after_stat(count)),stat='count',position=position_dodge(0.9),vjust=-0.3)+
  xlab("Clinical Condition")+
  ylab("count")

```



*****************************
# 3. ALPHA DIVERSITY ANALYSIS
*****************************

## 3.1. Rarefaction Curves

```{r rarefaction-curve, echo=FALSE}

# number of species against the number of samples
# This curve is created by randomly re-sampling the pool of N samples several times and then plotting the average number of species found on each sample

set.seed(1024)
rareres <- get_rarecurve(obj=physeq, chunks=400) # chunks: number of subsample in a sample


prare1 <- ggrarecurve(obj=rareres, factorNames="host_disease",
                      indexNames=c("Observe", "Chao1", "ACE")) +
          scale_fill_manual(values=c("#00AED7", "#FD9347"))+
          scale_color_manual(values=c("#00AED7", "#FD9347"))+
          theme_bw()+
          theme(axis.text=element_text(size=8), panel.grid=element_blank(),
                strip.background = element_rect(colour=NA,fill="grey"),
                strip.text.x = element_text(face="bold"))          
prare1


prare2 <- ggrarecurve(obj=rareres,
                      factorNames="host_disease",
                      shadow=FALSE,
                      indexNames=c("Observe", "Chao1", "ACE")) +
          scale_color_manual(values=c("#00AED7", "#FD9347"))+
          theme_bw()+
          theme(axis.text=element_text(size=8), panel.grid=element_blank(),
                strip.background = element_rect(colour=NA,fill="grey"),
                strip.text.x = element_text(face="bold"))
prare2

```


## 3.2. Analysis of Alpha Index

```{r alpha-diversity, echo=FALSE}

#   measure of microbiome diversity applicable to a single sample
#  for alpha diversity, many indices exist, each reflecting different aspects of community heterogeneity

alphaobj <- get_alphaindex(physeq)
head(as.data.frame(alphaobj))

p_alpha <- ggbox(alphaobj, geom="violin", factorNames="host_disease") +
           scale_fill_manual(values=c("#00AED7", "#FD9347"))+
           theme(strip.background = element_rect(colour=NA, fill="grey"))
p_alpha
```

**********************************
# 4. TAXONOMY COMPOSITION ANALYSIS
**********************************

## Statistics and visualization of specific levels (Composition)

## 4.1. Class Analysis

```{r plot-classes}
class.taxa <- get_taxadf(obj=physeq, taxlevel=3)

# Relative Abundance of the 30 most abundant taxonomy will be visualized by default (parameter `topn=30`). 
rel.ab_class <- ggbartax(obj=class.taxa, facetNames="host_disease") +
          xlab(NULL) +
          ylab("relative abundance (%)") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

rel.ab_class

# Show the relative abundance in different groups.
rel.ab.group_class <- ggbartax(obj=class.taxa, facetNames="host_disease",
                               plotgroup=TRUE, topn=15) +
          xlab(NULL) +
          ylab("relative abundance (%)") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5, ncol=2))

rel.ab.group_class

#Absolute abundance
abs.ab_class <- ggbartax(obj=class.taxa, count=TRUE, facetNames="host_disease") +
          xlab(NULL) +
          ylab("count reads") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

abs.ab_class

# Show the absolute abundance in different groups.
abs.ab.group_class <- ggbartax(obj=class.taxa, count=TRUE, facetNames="host_disease",
                               plotgroup=TRUE,topn=15) +
          xlab(NULL) +
          ylab("count reads") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

abs.ab.group_class

```

## 4.2. Phylum Analysis

```{r plot-phylum, fig.width = 10, fig.height = 4}
phylum.taxa <- get_taxadf(obj=physeq, taxlevel=2)

# Show the relative abundance
rel.ab_phylum <- ggbartax(obj=phylum.taxa, facetNames="host_disease") +
          xlab(NULL) +
          ylab("relative abundance (%)") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

rel.ab_phylum


# Show the relative abundance in different groups.
rel.ab.group_phylum <- ggbartax(obj=phylum.taxa, facetNames="host_disease",
                               plotgroup=TRUE, topn=15) +
          xlab(NULL) +
          ylab("relative abundance (%)") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5, ncol=2))

rel.ab.group_phylum


#Absolute abundance
abs.ab_phylum <- ggbartax(obj=phylum.taxa, count=TRUE, facetNames="host_disease") +
          xlab(NULL) +
          ylab("count reads") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

abs.ab_phylum


# Show the absolute  in different groups.
abs.ab.group_phylum <- ggbartax(obj=phylum.taxa, count=TRUE,
                                facetNames="host_disease", plotgroup=TRUE,topn=15) +
          xlab(NULL) +
          ylab("count reads") +
          guides(fill= guide_legend(keywidth = 0.5, keyheight = 0.5))

abs.ab.group_phylum

```



**********************************
# 5. FIRMICUES/BACTEROIDETES RATIO
**********************************

```{r firmicutes/bacteroidetes ratio, echo=FALSE}

# First, relative abundances are calculated. Average per group for each phylum respectively

# Agglomerate to phylum & genus levels
phylum.table <- physeq %>%
  tax_glom(taxrank = "Phylum") %>%                     # agglomerate at phylum level
  transform_sample_counts(function(x) {x/sum(x)} ) %>% # Transform to rel. abundance
  psmelt()                                             # Melt to long format

# Extract abundance of only Bacteroidota and Firmicutes
bacter <- phylum.table %>%
  filter(Phylum == "Bacteroidota") %>%
  select(c('Sample', 'Abundance', 'host_disease', 'Phylum')) %>%
  arrange(Sample)

firmi <- phylum.table %>%
  filter(Phylum == "Firmicutes") %>%
  select(c('Sample', 'Abundance', 'host_disease', 'Phylum')) %>%
  arrange(Sample)

# Calculate ratio Firmicutes/Bacteroidota
ratio.FB <- data.frame('Sample' = bacter$Sample,
                       'host_disease' = bacter$host_disease,
                       'Bacteroidota' = bacter$Abundance,
                       'Firmicutes' = firmi$Abundance)
ratio.FB$logRatioFB <- log2(ratio.FB$Firmicutes / ratio.FB$Bacteroidota)

# Plot FB Ratio
ggplot(ratio.FB, aes(x = host_disease, y = logRatioFB))+
  geom_violin(aes(fill=host_disease))+
  scale_fill_manual(values=scales::alpha(c("blue", "red"), .3))+
  geom_jitter(width=0.1)+
  geom_signif(comparisons = list(c("Healthy", "IBS")), map_signif_level = TRUE, test="wilcox.test") +
  labs(x = "",  y = 'Log2(Firmicutes/Bacteroidota)', title = "F/B ratio")+
  theme_cowplot()+
  theme(legend.position="none")
# ggsave(file.path(path.fukui, "plot_ratioFB.jpg"), width=4, height=6)

# Statistical test
wilcox.test(ratio.FB[ratio.FB$host_disease == "IBS","logRatioFB"],
            ratio.FB[ratio.FB$host_disease == "Healthy","logRatioFB"]) # p = 0.78

```

******************
# 6. BETA ANALYSIS
******************

## 6.1. PCA Analysis

```{r pca-analysis, fig.width = 10, fig.height = 4}

# If the input was normalized, the method parameter should be settled NULL.
pcares <- get_pca(obj=physeq, method="hellinger")

# Visualizing the result
pcaplot1 <- ggordpoint(obj=pcares, biplot=TRUE, speciesannot=TRUE,
                      factorNames=c("host_disease"), ellipse=TRUE) +
            scale_color_manual(values=c("#00AED7", "#FD9347")) +
            scale_fill_manual(values=c("#00AED7", "#FD9347"))

# pc = c(1, 3) to show the first and third principal components.
pcaplot2 <- ggordpoint(obj=pcares, pc=c(1, 3), biplot=TRUE, speciesannot=TRUE,
                       factorNames=c("host_disease"), ellipse=TRUE) +
            scale_color_manual(values=c("#00AED7", "#FD9347")) +
            scale_fill_manual(values=c("#00AED7", "#FD9347"))
pcaplot1 | pcaplot2

```


## 6.2. PCoA Analysis

```{r pcoa-analysis, fig.width = 10, fig.height = 4}

# distmethod
# "unifrac",  "wunifrac", "manhattan", "euclidean", "canberra", "bray", "kulczynski" ...(vegdist, dist)
pcoares <- get_pcoa(obj=physeq, distmethod="bray", method="hellinger")

# Visualizing the result
pcoaplot1 <- ggordpoint(obj=pcoares, biplot=TRUE, speciesannot=TRUE,
                       factorNames=c("host_disease"), ellipse=TRUE) +
            scale_color_manual(values=c("#00AED7", "#FD9347")) +
            scale_fill_manual(values=c("#00AED7", "#FD9347"))

# first and third principal co-ordinates
pcoaplot2 <- ggordpoint(obj=pcoares, pc=c(1, 3), biplot=TRUE, speciesannot=TRUE,
                        factorNames=c("host_disease"), ellipse=TRUE) +
             scale_color_manual(values=c("#00AED7", "#FD9347")) +
             scale_fill_manual(values=c("#00AED7", "#FD9347"))

pcoaplot1 | pcoaplot2

```


## 6.3. Permuatational Multivariate Anaylsis of Variance 

```{r perm-multi-analysis, echo=FALSE}

distme <- get_dist(physeq, distmethod ="bray", method="hellinger")
sampleda <- data.frame(sample_data(physeq), check.names=FALSE)
sampleda <- sampleda[match(colnames(as.matrix(distme)),rownames(sampleda)),,drop=FALSE]
sampleda$Group <- factor(sampleda$host_disease)
set.seed(1024)
adores <- adonis(distme ~ host_disease, data=sampleda, permutation=9999)
data.frame(adores$aov.tab)

```


## 6.4. Hierarchical Cluster Analysis of Samples

```{r hierarchical-cluster, fig.width = 10, fig.height = 4}

hcsample <- get_clust(obj=physeq, distmethod="bray",
                      method="hellinger", hclustmethod="average")
# rectangular layout
cplot1 <- ggclust(obj=hcsample,
                  layout = "rectangular",
                  pointsize=1,
                  fontsize=0,
                  factorNames=c("host_disease")
              ) +
              scale_color_manual(values=c("#00AED7", "#FD9347")) +
              theme_tree2(legend.position="right",
              plot.title = element_text(face="bold", lineheight=25,hjust=0.5))
# circular layout
cplot2 <- ggclust(obj=hcsample,
                  layout = "circular",
                  pointsize=1,
                  fontsize=2,
                  factorNames=c("host_disease")
          ) +
          scale_color_manual(values=c("#00AED7", "#FD9347")) +
          theme(legend.position="right")
cplot1 | cplot2

```








